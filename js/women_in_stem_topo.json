{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Women in STEM â€” choropleth using ne_110m_admin_0_countries.topojson with year slider, field selector and centroid fallback.",
  "width": 900,
  "height": 450,
  "params": [
    { "name": "yearParam", "value": 2020, "bind": {"input":"range","min":2000,"max":2023,"step":1} },
    { "name": "fieldParam", "value": "All", "bind": {"input":"select","options":["All","Engineering","Mathematics","Computer Science","Biology"]} }
  ],
  "layer": [
    {
      "name": "base_map",
      "data": {
        "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/js/ne_110m_admin_0_countries.topojson",
        "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
      },
      "mark": {"type":"geoshape", "fill":"#f2f2f2", "stroke":"#888", "strokeWidth":0.4}
    },

    {
      "name": "data_map",
      "data": {
        "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/js/ne_110m_admin_0_countries.topojson",
        "format": {"type":"topojson", "feature":"ne_110m_admin_0_countries"}
      },
      "transform": [
        {
          "lookup": "properties.ADMIN",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/women_in_stem.csv",
              "format": {"type":"csv"},
              "transform": [
                {
                  "calculate": "var c=(trim(datum.Country)||'').toLowerCase(); c==='usa'||c==='us'||c==='u.s.a.'||c==='united states' ? 'United States of America' : (c==='uk' ? 'United Kingdom' : (c==='aus'||c==='aust' ? 'Australia' : trim(datum.Country)))",
                  "as": "CountryNorm"
                },
                {"filter":"toNumber(datum.Year) === yearParam && (fieldParam === 'All' || datum['STEM Fields'] === fieldParam)"},
                {"calculate":"datum.CountryNorm","as":"Country"},
                {"aggregate":[{"op":"mean","field":"Female Enrollment (%)","as":"meanEnroll"}],"groupby":["Country"]}
              ]
            },
            "key": "Country",
            "fields": ["meanEnroll"]
          }
        },
        {"calculate":"datum.meanEnroll === null ? null : datum.meanEnroll","as":"enrollment"},
        {"filter":"datum.enrollment !== null"}
      ],
      "mark": {"type":"geoshape", "stroke":"#444", "strokeWidth":0.3},
      "encoding": {
        "color": {"field":"enrollment","type":"quantitative","scale":{"scheme":"blues"},"title":"Female Enrollment (%)"},
        "tooltip": [
          {"field":"properties.ADMIN","type":"nominal","title":"Country"},
          {"field":"enrollment","type":"quantitative","format":".2f","title":"Enrollment (%)"}
        ]
      }
    },

    {
      "name": "centroid_fallback",
      "data": {
        "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/countryInfo.csv",
        "format": {"type":"csv"}
      },
      "transform": [
        {
          "lookup": "name",
          "from": {
            "data": {
              "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/women_in_stem.csv",
              "format": {"type":"csv"},
              "transform": [
                {
                  "calculate": "var c=(trim(datum.Country)||'').toLowerCase(); c==='usa'||c==='us'||c==='u.s.a.'||c==='united states' ? 'United States of America' : (c==='uk' ? 'United Kingdom' : (c==='aus'||c==='aust' ? 'Australia' : trim(datum.Country)))",
                  "as": "CountryNorm"
                },
                {"filter":"toNumber(datum.Year) === yearParam && (fieldParam === 'All' || datum['STEM Fields'] === fieldParam)"},
                {"calculate":"datum.CountryNorm","as":"Country"},
                {"aggregate":[{"op":"mean","field":"Female Enrollment (%)","as":"meanEnroll"}],"groupby":["Country"]}
              ]
            },
            "key": "Country",
            "fields": ["meanEnroll"]
          }
        },
        {"calculate":"datum.meanEnroll === null ? null : datum.meanEnroll","as":"enrollment"},
        {"filter":"datum.enrollment !== null"},
        {"calculate":"toNumber(datum.longitude)","as":"lon"},
        {"calculate":"toNumber(datum.latitude)","as":"lat"}
      ],
      "mark": {"type":"circle","size":120,"stroke":"#222","strokeWidth":0.5},
      "encoding": {
        "longitude": {"field":"lon","type":"quantitative"},
        "latitude": {"field":"lat","type":"quantitative"},
        "color": {"field":"enrollment","type":"quantitative","scale":{"scheme":"blues"},"legend":null},
        "tooltip": [
          {"field":"name","type":"nominal","title":"Country (centroid)"},
          {"field":"enrollment","type":"quantitative","format":".2f","title":"Enrollment (%)"}
        ]
      }
    }
  ],
  "config": {"view": {"stroke":"transparent"}, "background":"#ffffff"}
}
