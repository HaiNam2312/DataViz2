<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Women in STEM — Choropleth test</title>
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>
</head>
<body>
  <div id="vis"></div>
  <script>
  const YEAR_TO_SHOW = 2020; // ← change this if you want to test other years

  const spec = {
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "width": 900,
    "height": 480,
    "projection": {"type": "equalEarth"},
    "layer": [
      {
        "data": {
          "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/7_others/oceans.topojson",
          "format": {"type":"topojson","feature":"oceans"}
        },
        "mark": {"type":"geoshape","fill":"#cfeeff","stroke": null}
      },

      {
        "data": {
          "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
          "format": {"type":"topojson","feature":"ne_110m_admin_0_countries"}
        },
        "mark": {"type":"geoshape","fill":"#f2f2f2","stroke":"#dcdcdc","strokeWidth":0.4},
        "transform": [
          {"calculate": "datum.properties && (datum.properties.ADMIN || datum.properties.NAME || datum.properties.name) ? datum.properties.ADMIN||datum.properties.NAME||datum.properties.name : ''", "as":"adminName"}
        ],
        "encoding": {
          "tooltip": [
            {"field":"adminName","type":"nominal","title":"Country"},
            {"field":"properties && properties.ADMIN ? properties.ADMIN : properties.NAME","type":"nominal","title":"(raw topojson name)"}
          ]
        }
      },

      // Choropleth layer: direct lookup join to CSV by country name
      {
        "data": {
          "url": "https://raw.githubusercontent.com/FIT3179/Vega-Lite/main/3_choropleth_map/js/ne_110m_admin_0_countries.topojson",
          "format": {"type": "topojson", "feature": "ne_110m_admin_0_countries"}
        },
        "transform": [
          {
            "lookup": "properties.ADMIN",
            "from": {
              "data": {
                "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/women_in_stem.csv",
                "format": {"type": "csv"},
                "transform": [
                  {"filter": "toNumber(datum.Year) === " + YEAR_TO_SHOW},
                  {"aggregate": [
                    {"op": "mean", "field": "Female Enrollment (%)", "as": "meanEnroll"}
                  ], "groupby": ["Country"]}
                ]
              },
              "key": "Country",
              "fields": ["meanEnroll"]
            }
          }
        ],
        "mark": {"type": "geoshape", "stroke": "#fff", "strokeWidth": 0.4},
        "encoding": {
          "color": {
            "field": "meanEnroll",
            "type": "quantitative",
            "scale": {"domain": [0, 100], "scheme": "blues"},
            "legend": {"title": "Female Enrollment (%)"}
          },
          "tooltip": [
            {"field": "properties.ADMIN", "type": "nominal", "title": "Country"},
            {"field": "meanEnroll", "type": "quantitative", "format": ".2f", "title": "Enrollment (%)"}
          ]
        }
      },

      // Centroid fallback: plot points for matched countries (helps debugging/makes data presence visible)
      {
        "data": {
          "url": "https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/countryInfo.csv",
          "format": {"type":"csv"}
        },
        "transform":[
          {"calculate":"lower(trim(datum.name))","as":"name_norm"},
          // lookup aggregated csv same as above
          {
            "lookup":"name_norm",
            "from": {
              "data": {
                "url":"https://raw.githubusercontent.com/HaiNam2312/DataViz2/main/data/women_in_stem.csv",
                "format":{"type":"csv"},
                "transform":[
                  {"calculate":
                    "var c = lower(trim(datum.Country));" +
                    "if(!c) '';" +
                    "else if (c==='usa' || c==='us' || c==='u.s.a.' || c==='united states') 'united states of america'" +
                    "else if (c==='uk') 'united kingdom'" +
                    "else if (c==='aus' || c==='aust') 'australia'" +
                    "else lower(trim(datum.Country));",
                   "as":"CountryNorm"
                  },
                  {"filter": "toNumber(datum.Year) === " + YEAR_TO_SHOW},
                  {"calculate":"datum.CountryNorm","as":"CountryKey"},
                  {"aggregate":[
                    {"op":"mean","field":"Female Enrollment (%)","as":"meanEnroll"},
                    {"op":"mean","field":"Female Graduation Rate (%)","as":"meanGrad"},
                    {"op":"mean","field":"Gender Gap Index","as":"meanGap"}
                  ], "groupby":["CountryKey"]}
                ]
              },
              "key":"CountryKey",
              "fields":["meanEnroll","meanGrad","meanGap"]
            }
          },
          {"calculate":"datum.meanEnroll === null ? null : datum.meanEnroll","as":"enrollment"},
          {"filter":"datum.enrollment !== null"},
          {"calculate":"toNumber(datum.longitude)","as":"lon"},
          {"calculate":"toNumber(datum.latitude)","as":"lat"}
        ],
        "mark":{"type":"circle","size":90,"stroke":"#222","strokeWidth":0.6},
        "encoding":{
          "longitude":{"field":"lon","type":"quantitative"},
          "latitude":{"field":"lat","type":"quantitative"},
          "color":{"field":"enrollment","type":"quantitative","scale":{"domain":[0,100],"scheme":"blues"},"legend":null},
          "tooltip":[
            {"field":"name","type":"nominal","title":"Country (centroid)"},
            {"field":"enrollment","type":"quantitative","format":".2f","title":"Enrollment (%)"},
            {"field":"meanGrad","type":"quantitative","format":".2f","title":"Graduation Rate (%)"},
            {"field":"meanGap","type":"quantitative","format":".2f","title":"Gender Gap Index"}
          ]
        }
      }
    ],
    "config": {"view":{"stroke":"transparent"}}
  };

  vegaEmbed("#vis", spec, {mode:"vega-lite", actions:{export:true,source:true,compiled:true}})
    .then(r=>console.log("embed ok")).catch(e=>{console.error(e); alert('embed error - check console');});
  </script>
</body>
</html>
